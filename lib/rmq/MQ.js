"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const amqplib_1 = require("amqplib");
class MQ {
    static async getConn() {
        if (!MQ._conn) {
            MQ._conn = await amqplib_1.connect(`amqp://${encodeURIComponent(MQ.user)}:${encodeURIComponent(MQ.pass)}@${MQ.host}/${MQ.vhost}`);
            MQ._conn.on('close', () => (MQ._conn = null));
        }
        return MQ._conn;
    }
    static async getCh() {
        if (!MQ._ch) {
            const conn = await MQ.getConn();
            MQ._ch = await conn.createChannel();
            MQ._ch.on('close', () => (MQ._ch = null));
        }
        return MQ._ch;
    }
    static async getEx() {
        if (!MQ._ex) {
            const ch = await MQ.getCh();
            MQ._ex = await ch.assertExchange(MQ.defaultExchangeName, 'topic', { durable: true });
        }
        return MQ._ex;
    }
    /**
     * Consume message received to the queue assigned to this service
     * use
     * mq.consume( async (msg, data) => {
     *  ...
     *  (await mq.getCh).ack(msg);
     * });
     * @param onMessage(msg, data?) contains original message and data if it could be parsed to JSON
     * @param options
     */
    static async consume(onMessage, options) {
        return await (await MQ.getCh()).consume(MQ.receiveQueueName, (msg) => {
            let data;
            try {
                data = JSON.parse(msg.content.toString());
            }
            catch (err) {
                global.logger.error(`RMQ message could not be parsed to json object: ${err}`);
            }
            onMessage(msg, data);
        }, options);
    }
    /**
     * Bind queue to exchange
     * ...bindings
     * mq.receive.bindQueue('parser.html.diff-notifier', [(await mq.getEx).exchange]);
     * ...
     * @param pattern Route path <serviceName>.<action>.<option1>.<option2>
     * @param exchangeSource (optional)
     * @param args (optional)
     */
    static async bindQueue(pattern, exchangeSource, args) {
        exchangeSource = exchangeSource || (await MQ.getEx()).exchange;
        return await (await MQ.getCh()).bindQueue(MQ.receiveQueueName, exchangeSource, pattern, args);
    }
    /**
     * Push messages to RMQ
     * use
     * mq.send.publish('action.option1', content);
     *
     * @param routingKey Route key which is automatically prefixed with service name <action>.<option1>.<option2>
     * @param content can be object or buffer
     * @param options
     */
    static async publish(routingKey, content, options) {
        if (!Buffer.isBuffer(content))
            content = new Buffer(JSON.stringify(content));
        return (await MQ.getCh()).publish((await MQ.getEx()).exchange, `${global.projectName.toLowerCase()}.${routingKey}`, content, options);
    }
    static async init(config) {
        MQ.user = config.rabbitMqUser;
        MQ.pass = config.rabbitMqPass;
        MQ.host = config.rabbitMqHost;
        MQ.vhost = config.rabbitMqVhost;
        MQ.receiveQueueName = config.receiveQueueName;
        MQ.defaultExchangeName = config.defaultExchangeName;
        // TODO get connection, on error set timeout and try again
        await MQ.getEx();
        const ch = await MQ.getCh();
        await ch.assertQueue(MQ.receiveQueueName);
        await ch.prefetch(1);
    }
}
exports.MQ = MQ;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTVEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcm1xL01RLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQWlHO0FBRWpHLE1BQWEsRUFBRTtJQVdOLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTztRQUN6QixJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRTtZQUNiLEVBQUUsQ0FBQyxLQUFLLEdBQUcsTUFBTSxpQkFBTyxDQUN0QixVQUFVLGtCQUFrQixDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFFLENBQzlGLENBQUE7WUFDRCxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUE7U0FDOUM7UUFDRCxPQUFPLEVBQUUsQ0FBQyxLQUFNLENBQUE7SUFDbEIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSztRQUN2QixJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRTtZQUNYLE1BQU0sSUFBSSxHQUFHLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQy9CLEVBQUUsQ0FBQyxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7WUFDbkMsRUFBRSxDQUFDLEdBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFBO1NBQzNDO1FBQ0QsT0FBTyxFQUFFLENBQUMsR0FBSSxDQUFBO0lBQ2hCLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUs7UUFDdkIsSUFBSSxDQUFDLEVBQUUsQ0FB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QUFBO1FBQzNCLE1BQU0sRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtRQUN6QyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdEIsQ0FBQztDQUNGO0FBbEhELGdCQWtIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5uZWwsIGNvbm5lY3QsIENvbm5lY3Rpb24sIENvbnN1bWVNZXNzYWdlLCBNZXNzYWdlLCBPcHRpb25zLCBSZXBsaWVzIH0gZnJvbSAnYW1xcGxpYidcblxuZXhwb3J0IGNsYXNzIE1RIHtcbiAgcHJpdmF0ZSBzdGF0aWMgX2Nvbm46IENvbm5lY3Rpb24gfCBudWxsXG4gIHByaXZhdGUgc3RhdGljIF9jaDogQ2hhbm5lbCB8IG51bGxcbiAgcHJpdmF0ZSBzdGF0aWMgX2V4OiBSZXBsaWVzLkFzc2VydEV4Y2hhbmdlIHwgbnVsbFxuICBwcml2YXRlIHN0YXRpYyB1c2VyOiBzdHJpbmdcbiAgcHJpdmF0ZSBzdGF0aWMgcGFzczogc3RyaW5nXG4gIHByaXZhdGUgc3RhdGljIGhvc3Q6IHN0cmluZ1xuICBwcml2YXRlIHN0YXRpYyB2aG9zdDogc3RyaW5nXG4gIHByaXZhdGUgc3RhdGljIHJlY2VpdmVRdWV1ZU5hbWU6IHN0cmluZ1xuICBwcml2YXRlIHN0YXRpYyBkZWZhdWx0RXhjaGFuZ2VOYW1lOiBzdHJpbmdcblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIGdldENvbm4oKTogUHJvbWlzZTxDb25uZWN0aW9uPiB7XG4gICAgaWYgKCFNUS5fY29ubikge1xuICAgICAgTVEuX2Nvbm4gPSBhd2FpdCBjb25uZWN0KFxuICAgICAgICBgYW1xcDovLyR7ZW5jb2RlVVJJQ29tcG9uZW50KE1RLnVzZXIpfToke2VuY29kZVVSSUNvbXBvbmVudChNUS5wYXNzKX1AJHtNUS5ob3N0fS8ke01RLnZob3N0fWBcbiAgICAgIClcbiAgICAgIE1RLl9jb25uLm9uKCdjbG9zZScsICgpID0+IChNUS5fY29ubiA9IG51bGwpKVxuICAgIH1cbiAgICByZXR1cm4gTVEuX2Nvbm4hXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIGdldENoKCk6IFByb21pc2U8Q2hhbm5lbD4ge1xuICAgIGlmICghTVEuX2NoKSB7XG4gICAgICBjb25zdCBjb25uID0gYXdhaXQgTVEuZ2V0Q29ubigpXG4gICAgICBNUS5fY2ggPSBhd2FpdCBjb25uLmNyZWF0ZUNoYW5uZWwoKVxuICAgICAgTVEuX2NoIS5vbignY2xvc2UnLCAoKSA9PiAoTVEuX2NoID0gbnVsbCkpXG4gICAgfVxuICAgIHJldHVybiBNUS5fY2ghXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIGdldEV4KCk6IFByb21pc2U8UmVwbGllcy5Bc3NlcnRFeGNoYW5nZT4ge1xuICAgIGlmICghTVEuX2V4KSB7XG4gICAgICBjb25zdCBjaCA9IGF3YWl0IE1RLmdldENoKClcbiAgICAgIE1RLl9leCA9IGF3YWl0IGNoLmFzc2VydEV4Y2hhbmdlKE1RLmRlZmF1bHRFeGNoYW5nZU5hbWUsICd0b3BpYycsIHsgZHVyYWJsZTogdHJ1ZSB9KVxuICAgIH1cbiAgICByZXR1cm4gTVEuX2V4XG4gIH1cblxuICAvKipcbiAgICogQ29uc3VtZSBtZXNzYWdlIHJlY2VpdmVkIHRvIHRoZSBxdWV1ZSBhc3NpZ25lZCB0byB0aGlzIHNlcnZpY2VcbiAgICogdXNlXG4gICAqIG1xLmNvbnN1bWUoIGFzeW5jIChtc2csIGRhdGEpID0+IHtcbiAgICogIC4uLlxuICAgKiAgKGF3YWl0IG1xLmdldENoKS5hY2sobXNnKTtcbiAgICogfSk7XG4gICAqIEBwYXJhbSBvbk1lc3NhZ2UobXNnLCBkYXRhPykgY29udGFpbnMgb3JpZ2luYWwgbWVzc2FnZSBhbmQgZGF0YSBpZiBpdCBjb3VsZCBiZSBwYXJzZWQgdG8gSlNPTlxuICAgKiBAcGFyYW0gb3B0aW9uc1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyBjb25zdW1lKFxuICAgIG9uTWVzc2FnZTogKG1zZzogTWVzc2FnZSwgZGF0YT86IGFueSkgPT4gYW55LFxuICAgIG9wdGlvbnM/OiBPcHRpb25zLkNvbnN1bWVcbiAgKTogUHJvbWlzZTxSZXBsaWVzLkNvbnN1bWU+IHtcbiAgICByZXR1cm4gYXdhaXQgKGF3YWl0IE1RLmdldENoKCkpLmNvbnN1bWUoXG4gICAgICBNUS5yZWNlaXZlUXVldWVOYW1lLFxuICAgICAgKG1zZzogQ29uc3VtZU1lc3NhZ2UgfCBudWxsKSA9PiB7XG4gICAgICAgIGxldCBkYXRhOiBhbnlcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZShtc2chLmNvbnRlbnQudG9TdHJpbmcoKSlcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgZ2xvYmFsLmxvZ2dlci5lcnJvcihgUk1RIG1lc3NhZ2UgY291bGQgbm90IGJlIHBhcnNlZCB0byBqc29uIG9iamVjdDogJHtlcnJ9YClcbiAgICAgICAgfVxuICAgICAgICBvbk1lc3NhZ2UobXNnISwgZGF0YSlcbiAgICAgIH0sXG4gICAgICBvcHRpb25zXG4gICAgKVxuICB9XG5cbiAgLyoqXG4gICAqIEJpbmQgcXVldWUgdG8gZXhjaGFuZ2VcbiAgICogLi4uYmluZGluZ3NcbiAgICogbXEucmVjZWl2ZS5iaW5kUXVldWUoJ3BhcnNlci5odG1sLmRpZmYtbm90aWZpZXInLCBbKGF3YWl0IG1xLmdldEV4KS5leGNoYW5nZV0pO1xuICAgKiAuLi5cbiAgICogQHBhcmFtIHBhdHRlcm4gUm91dGUgcGF0aCA8c2VydmljZU5hbWU+LjxhY3Rpb24+LjxvcHRpb24xPi48b3B0aW9uMj5cbiAgICogQHBhcmFtIGV4Y2hhbmdlU291cmNlIChvcHRpb25hbClcbiAgICogQHBhcmFtIGFyZ3MgKG9wdGlvbmFsKVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyBiaW5kUXVldWUocGF0dGVybjogc3RyaW5nLCBleGNoYW5nZVNvdXJjZT86IHN0cmluZywgYXJncz86IGFueSk6IFByb21pc2U8UmVwbGllcy5FbXB0eT4ge1xuICAgIGV4Y2hhbmdlU291cmNlID0gZXhjaGFuZ2VTb3VyY2UgfHwgKGF3YWl0IE1RLmdldEV4KCkpLmV4Y2hhbmdlXG4gICAgcmV0dXJuIGF3YWl0IChhd2FpdCBNUS5nZXRDaCgpKS5iaW5kUXVldWUoTVEucmVjZWl2ZVF1ZXVlTmFtZSwgZXhjaGFuZ2VTb3VyY2UsIHBhdHRlcm4sIGFyZ3MpXG4gIH1cblxuICAvKipcbiAgICogUHVzaCBtZXNzYWdlcyB0byBSTVFcbiAgICogdXNlXG4gICAqIG1xLnNlbmQucHVibGlzaCgnYWN0aW9uLm9wdGlvbjEnLCBjb250ZW50KTtcbiAgICpcbiAgICogQHBhcmFtIHJvdXRpbmdLZXkgUm91dGUga2V5IHdoaWNoIGlzIGF1dG9tYXRpY2FsbHkgcHJlZml4ZWQgd2l0aCBzZXJ2aWNlIG5hbWUgPGFjdGlvbj4uPG9wdGlvbjE+LjxvcHRpb24yPlxuICAgKiBAcGFyYW0gY29udGVudCBjYW4gYmUgb2JqZWN0IG9yIGJ1ZmZlclxuICAgKiBAcGFyYW0gb3B0aW9uc1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyBwdWJsaXNoKHJvdXRpbmdLZXk6IHN0cmluZywgY29udGVudDogQnVmZmVyIHwgYW55LCBvcHRpb25zPzogT3B0aW9ucy5QdWJsaXNoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoY29udGVudCkpIGNvbnRlbnQgPSBuZXcgQnVmZmVyKEpTT04uc3RyaW5naWZ5KGNvbnRlbnQpKVxuICAgIHJldHVybiAoYXdhaXQgTVEuZ2V0Q2goKSkucHVibGlzaChcbiAgICAgIChhd2FpdCBNUS5nZXRFeCgpKS5leGNoYW5nZSxcbiAgICAgIGAke2dsb2JhbC5wcm9qZWN0TmFtZS50b0xvd2VyQ2FzZSgpfS4ke3JvdXRpbmdLZXl9YCxcbiAgICAgIGNvbnRlbnQsXG4gICAgICBvcHRpb25zXG4gICAgKVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBpbml0KGNvbmZpZzogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgTVEudXNlciA9IGNvbmZpZy5yYWJiaXRNcVVzZXJcbiAgICBNUS5wYXNzID0gY29uZmlnLnJhYmJpdE1xUGFzc1xuICAgIE1RLmhvc3QgPSBjb25maWcucmFiYml0TXFIb3N0XG4gICAgTVEudmhvc3QgPSBjb25maWcucmFiYml0TXFWaG9zdFxuICAgIE1RLnJlY2VpdmVRdWV1ZU5hbWUgPSBjb25maWcucmVjZWl2ZVF1ZXVlTmFtZVxuICAgIE1RLmRlZmF1bHRFeGNoYW5nZU5hbWUgPSBjb25maWcuZGVmYXVsdEV4Y2hhbmdlTmFtZVxuXG4gICAgLy8gVE9ETyBnZXQgY29ubmVjdGlvbiwgb24gZXJyb3Igc2V0IHRpbWVvdXQgYW5kIHRyeSBhZ2FpblxuICAgIGF3YWl0IE1RLmdldEV4KClcbiAgICBjb25zdCBjaCA9IGF3YWl0IE1RLmdldENoKClcbiAgICBhd2FpdCBjaC5hc3NlcnRRdWV1ZShNUS5yZWNlaXZlUXVldWVOYW1lKVxuICAgIGF3YWl0IGNoLnByZWZldGNoKDEpXG4gIH1cbn1cbiJdfQ==